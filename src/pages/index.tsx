import { type NextPage } from "next";
import Head from "next/head";
import { signIn, signOut, useSession } from "next-auth/react";
import { trpc } from "../utils/trpc";
import Header from "../components/Header";
import SidebarList from "../components/SidebarList";
import Hero from "../components/Hero";
import type { Media } from "../types/interface";
import { useState } from "react";
import { FontAwesomeIcon } from "@fortawesome/react-fontawesome";
import { faSpinner } from "@fortawesome/free-solid-svg-icons";

const Home: NextPage = () => {
  const session = useSession()
  const { data: trending } = trpc.media.getTrendingData.useQuery()
  const user = trpc.user.getUser.useQuery()
  const listItems = trpc.listItem.getUserListItems.useQuery()
  const addListItemToDB = trpc.listItem.newListItem.useMutation()
  const removeListItemFromDB = trpc.listItem.removeListItem.useMutation()
  const utils = trpc.useContext()
  const [show, setShow] = useState(false)
  
  const addListItem = (newListItem:{media:Media, userID:string}) =>{
    addListItemToDB.mutate(newListItem, {onSuccess:async ()=>{ utils.listItem.getUserListItems.invalidate()}})
    return addListItemToDB.isLoading ? true : false
  }
  const removeListItem = (id:string) =>{
    removeListItemFromDB.mutate(id, {onSuccess:async ()=>{ utils.listItem.getUserListItems.invalidate()}})
    return removeListItemFromDB.isLoading ? true : false
  }
  
  if(!trending || session.status === "loading" || listItems.isLoading || user.isLoading){
    return (
      <div className="w-screen h-screen bg-slate-600 flex flex-col gap-8 justify-center items-center">
        <FontAwesomeIcon spin icon={faSpinner} size={"10x"}/>
        <div className="text-white font-bold cursor-pointer p-6 bg-black">Loading...</div>
      </div>)
  } else if(listItems.error || user.error || session.status === "unauthenticated"){
    return (
      <div className="w-screen h-screen bg-slate-600 flex justify-center items-center">
        <div className="text-white font-bold cursor-pointer p-6 bg-black" onClick={()=>signIn()}>Sign In</div>
      </div>
    )
  }else{
  const sidebarProps = {
    listItems: listItems.data, 
    removeListItem}
  const headerProps = {signIn, signOut, session: session.data, listItems: listItems.data, show, setShow, addListItem, removeListItem}
  const heroProps = {
    trending: trending,
    listItems: listItems.data ? listItems.data : undefined,
    addListItem: addListItem,
    removeListItem: removeListItem,
    session: session.data,
    user: user.data ? user.data : null
  }

  return (
    <>
      <Head>
        <title>StreamSave</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header {...headerProps} />
      <div className="bg-slate-300 mt-16 z-0" onClick={()=> show && setShow(false)}>
        <div className="flex justify-center max-w-8xl">
          <Hero {...heroProps} />
          {listItems && <SidebarList {...sidebarProps} />}
        </div>
      </div>
    </>
  );
}};

export default Home;