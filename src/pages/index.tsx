import { type NextPage } from "next";
import Head from "next/head";
import { signIn, signOut, useSession } from "next-auth/react";
import { trpc } from "../utils/trpc";
import Header from "../components/Header";
import SidebarList from "../components/SidebarList";
import Hero from "../components/Hero";
import { Media } from "../types/interface";
import { useState } from "react";


const Home: NextPage = () => {
  const { data: session, status } = useSession()
  const { data: trending } = trpc.media.getTrendingData.useQuery()
  const { data: user } = trpc.user.getUser.useQuery()
  const { data: listItems, status: listItemStatus } = trpc.listItem.getUserListItems.useQuery()
  const addListItemToDB = trpc.listItem.newListItem.useMutation()
  const removeListItemFromDB = trpc.listItem.removeListItem.useMutation()
  const utils = trpc.useContext()
  const [show, setShow] = useState(false)
  
  const addListItem = (newListItem:{media:Media, userID:string}) =>{
    addListItemToDB.mutate(newListItem, {onSuccess:async ()=>{ utils.listItem.getUserListItems.invalidate()}})
    return addListItemToDB.isLoading ? true : false
  }
  const removeListItem = (id:string) =>{
    removeListItemFromDB.mutate(id, {onSuccess:async ()=>{ utils.listItem.getUserListItems.invalidate()}})
    return removeListItemFromDB.isLoading ? true : false
  }
  
  if(!trending || status === "loading" || listItemStatus === "loading" || user === undefined) return <>Loading</>
  const sidebarProps = {listItems, removeListItem}
  const headerProps = {signIn, signOut, session, listItems, show, setShow, addListItem, removeListItem}
  const heroProps = {
    trending: trending,
    listItems: listItems,
    addListItem: addListItem,
    removeListItem: removeListItem,
    session: session,
    user: user,
  }

  return (
    <>
      <Head>
        <title>StreamSave</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Header {...headerProps} />
      <div className="bg-slate-300 mt-16 z-0" onClick={()=> show && setShow(false)}>
        <div className="flex justify-center max-w-8xl">
          <Hero {...heroProps} />
          {listItems && <SidebarList {...sidebarProps} />}
        </div>
      </div>
    </>
  );
};

export default Home;